name: Gemini Runner (Issue + Manual)

on:
  # 1) Issue ochilganda ishlasin (xohlasang)
  issues:
    types: [opened]

  # 2) Har safar issue ochmasdan, tugma bilan ishga tushirish
  workflow_dispatch:
    inputs:
      task:
        description: "Gemini uchun task/prompt yozing"
        required: true
        type: string
      model:
        description: "Model (gemini-1.5-pro yoki gemini-1.5-flash)"
        required: false
        default: "gemini-1.5-pro"
        type: string

jobs:
  gemini:
    runs-on: ubuntu-latest

    steps:
      - name: Taskni tanlash (Issue yoki Manual)
        id: pick
        run: |
          if [ -n "${{ github.event.issue.body }}" ]; then
            echo "TASK<<EOF" >> $GITHUB_OUTPUT
            echo "Title: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "SOURCE=issue" >> $GITHUB_OUTPUT
          else
            echo "TASK<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.inputs.task }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "SOURCE=manual" >> $GITHUB_OUTPUT
          fi

      - name: Gemini ga so'rov yuborish
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TASK: ${{ steps.pick.outputs.TASK }}
          MODEL: ${{ github.event.inputs.model || 'gemini-1.5-pro' }}
        run: |
          echo "SOURCE: ${{ steps.pick.outputs.SOURCE }}"
          echo "MODEL: $MODEL"
          echo ""
          echo "===== TASK ====="
          echo "$TASK"
          echo ""

          # JSON body tayyorlash
          BODY=$(jq -n --arg text "$TASK" '{contents:[{parts:[{text:$text}]}]}')

          echo "===== GEMINI RAW JSON RESPONSE ====="
          RESP=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          echo "$RESP"
          echo ""

          echo "===== GEMINI TEXT (tozalangan) ====="
          echo "$RESP" | jq -r '.candidates[0].content.parts[0].text // "No text returned (check API key/model/limits)"'
