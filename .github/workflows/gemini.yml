name: Gemini Runner (Issue + Manual)

on:
  # Issue ochilganda ham ishlasin
  issues:
    types: [opened]

  # Har safar issue ochmasdan, Run workflow tugmasi bilan ham ishlasin
  workflow_dispatch:
    inputs:
      task:
        description: "Gemini uchun task/prompt yozing"
        required: true
        type: string
      model:
        description: "Model nomi (masalan: models/gemini-2.5-pro yoki models/gemini-3-pro-preview)"
        required: false
        default: "models/gemini-2.5-pro"
        type: string

jobs:
  gemini:
    runs-on: ubuntu-latest

    steps:
      - name: Taskni tanlash (Issue yoki Manual)
        id: pick
        run: |
          if [ -n "${{ github.event.issue.body }}" ]; then
            echo "TASK<<EOF" >> $GITHUB_OUTPUT
            echo "Title: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "SOURCE=issue" >> $GITHUB_OUTPUT
          else
            echo "TASK<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.inputs.task }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "SOURCE=manual" >> $GITHUB_OUTPUT
          fi

      - name: Gemini modellari ro'yxati (ListModels)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "===== LIST MODELS ====="
          curl -s "https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}" \
            | jq -r '.models[].name'

      - name: Gemini ga so'rov yuborish
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TASK: ${{ steps.pick.outputs.TASK }}
          MODEL: ${{ github.event.inputs.model || 'models/gemini-2.5-pro' }}
        run: |
          echo "SOURCE: ${{ steps.pick.outputs.SOURCE }}"
          echo "MODEL: $MODEL"
          echo ""
          echo "===== TASK ====="
          echo "$TASK"
          echo ""

          BODY=$(jq -n --arg text "$TASK" '{contents:[{parts:[{text:$text}]}]}')

          echo "===== GEMINI RAW JSON RESPONSE ====="
          RESP=$(curl -s "https://generativelanguage.googleapis.com/v1beta/${MODEL}:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          echo "$RESP"
          echo ""

          echo "===== GEMINI TEXT (tozalangan) ====="
          echo "$RESP" | jq -r '.candidates[0].content.parts[0].text // "No text returned (check model/limits/API key)"'
